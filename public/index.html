<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco åœ¨çº¿ç¼–è¾‘å™¨ - R2 é›†æˆ</title>
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/editor/editor.main.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #1e1e1e; color: #cccccc; }
        .vscode-layout { display: flex; flex-direction: column; height: 100vh; }
        .top-menu-bar { background-color: #3c3c3c; padding: 0 0.5rem; height: 30px; display: flex; align-items: center; font-size: 0.875rem; border-bottom: 1px solid #252526; flex-shrink: 0; position: relative; }
        .menu-item-group { position: relative; }
        .menu-button { padding: 0.25rem 0.75rem; cursor: pointer; border-radius: 0.25rem; background: none; border: none; color: #cccccc; font-size: 0.875rem; }
        .menu-button:hover { background-color: #505050; }
        .dropdown-content { display: none; position: absolute; top: 100%; left: 0; background-color: #252526; min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 100; border: 1px solid #3c3c3c; border-radius: 0.25rem; padding: 0.25rem 0; }
        .dropdown-content button { color: #cccccc; padding: 0.5rem 1rem; text-decoration: none; display: block; width: 100%; text-align: left; background: none; border: none; font-size: 0.875rem; cursor: pointer; }
        .dropdown-content button:hover { background-color: #007acc; color: white; }
        .dropdown-content button.disabled { color: #666; cursor: not-allowed; }
        .dropdown-content button.disabled:hover { background-color: #252526; }
        .dropdown-content .separator { height: 1px; background-color: #3c3c3c; margin: 0.25rem 0; }
        .top-menu-bar .controls-container { display: flex; align-items: center; margin-left: auto; gap: 0.75rem; }
        .controls-container label { font-weight: 400; color: #cccccc; }
        .controls-container select { padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #505050; background-color: #3c3c3c; color: #cccccc; font-size: 0.875rem; cursor: pointer; }
        .controls-container select:hover { border-color: #686868; background-color: #505050; }

        .main-content { display: flex; flex-grow: 1; overflow: hidden; }
        /* Activity Bar */
        .activity-bar { width: 50px; background-color: #333333; padding: 0.5rem 0; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; border-right: 1px solid #252526; flex-shrink: 0; }
        .activity-bar .icon { width: 32px; height: 32px; border-radius: 0.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #cccccc; }
        .activity-bar .icon:hover { background-color: #505050; }
        .activity-bar .icon.active { background-color: #007acc; }
        .activity-bar .icon svg { width: 20px; height: 20px; fill: currentColor; }

        /* Primary Side Bar (for File Explorer) */
        .primary-side-bar { width: 250px; background-color: #252526; border-right: 1px solid #1e1e1e; display: none; /* Hidden by default */ flex-direction: column; padding: 0.5rem; overflow-y: auto; }
        .primary-side-bar.visible { display: flex; }
        .primary-side-bar h3 { margin: 0 0 0.5rem 0.25rem; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: #ccc; }
        .file-list { list-style: none; padding: 0; margin: 0; }
        .file-list li { padding: 0.35rem 0.5rem; cursor: pointer; border-radius: 0.25rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .file-list li:hover { background-color: #37373d; }
        .file-list li.active-file { background-color: #094771; }
        .file-item-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .file-item-actions button { background: none; border: none; color: #ccc; cursor: pointer; padding: 2px 4px; font-size: 0.9em; }
        .file-item-actions button:hover { color: #fff; }
        .r2-controls { margin-bottom: 0.5rem; display: flex; gap: 0.5rem; }
        .r2-controls button { background-color: #007acc; color: white; border: none; padding: 0.3rem 0.6rem; font-size: 0.8rem; border-radius: 3px; cursor: pointer; }
        .r2-controls button:hover { background-color: #005a9e; }


        .editor-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #editor-container { flex-grow: 1; border: none; }

        .bottom-status-bar { background-color: #007acc; color: #ffffff; padding: 0 1rem; height: 22px; display: flex; align-items: center; font-size: 0.75rem; flex-shrink: 0; gap: 1rem; }
        .bottom-status-bar .status-item { cursor: default; }
        .bottom-status-bar .status-item:hover { background-color: rgba(255,255,255,0.1); border-radius:0.25rem; padding: 0 0.25rem; }

        #message-box, .modal-overlay { position: fixed; z-index: 1000; }
        #message-box { top: 40px; left: 50%; transform: translateX(-50%); background-color: #252526; color: #cccccc; padding: 0.75rem 1.25rem; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; visibility: hidden; font-size: 0.875rem; }
        #message-box.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

        .modal-overlay { display: none; /* Hidden by default */ left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #2d2d2d; padding: 20px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.5); color: #cccccc; min-width: 300px; max-width: 400px; }
        .modal-content h2 { margin-top: 0; color: #0098ff; }
        .modal-content label { display: block; margin-bottom: 0.3rem; font-size: 0.9rem; }
        .modal-content input[type="password"], .modal-content input[type="text"], .modal-content input[type="number"] { width: calc(100% - 22px); padding: 8px 10px; margin-bottom: 10px; border-radius: 3px; border: 1px solid #555; background-color: #3c3c3c; color: #ccc; }
        .modal-content button { padding: 8px 15px; margin-top: 10px; border: none; border-radius: 3px; cursor: pointer; background-color: #007acc; color: white; }
        .modal-content button.cancel { background-color: #555; margin-left: 10px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="vscode-layout">
        <div class="top-menu-bar">
            <div class="menu-item-group">
                <button class="menu-button" data-dropdown="file-dropdown">æ–‡ä»¶(F)</button>
                <div id="file-dropdown" class="dropdown-content">
                    <button id="file-new">æ–°å»º</button>
                    <button id="file-open-local">ä»æœ¬åœ°æ‰“å¼€...</button>
                    <div class="separator"></div>
                    <button id="file-save-r2" class="disabled" title="å…ˆè¿æ¥åˆ°R2æ‰èƒ½ä¿å­˜">ä¿å­˜åˆ° R2</button>
                    <button id="file-download-local">ä¸‹è½½åˆ°æœ¬åœ°...</button>
                </div>
            </div>
            <div class="menu-item-group">
                <button class="menu-button" data-dropdown="edit-dropdown">ç¼–è¾‘(E)</button>
                <div id="edit-dropdown" class="dropdown-content">
                    <button id="edit-undo">æ’¤é”€</button>
                    <button id="edit-redo">é‡åš</button>
                    <div class="separator"></div>
                    <button id="edit-find">æŸ¥æ‰¾</button>
                    <button id="edit-replace">æ›¿æ¢</button>
                </div>
            </div>
            <div class="menu-item-group">
                <button class="menu-button" data-dropdown="selection-dropdown">é€‰æ‹©(S)</button>
                <div id="selection-dropdown" class="dropdown-content">
                    <button id="selection-select-all">å…¨é€‰</button>
                </div>
            </div>
            <div class="menu-item-group">
                <button class="menu-button" data-dropdown="view-dropdown">æŸ¥çœ‹(V)</button>
                <div id="view-dropdown" class="dropdown-content">
                    <button id="view-toggle-minimap">åˆ‡æ¢ Minimap</button>
                    <button id="view-toggle-wordwrap">åˆ‡æ¢è‡ªåŠ¨æ¢è¡Œ</button>
                </div>
            </div>
             <div class="menu-item-group">
                <button class="menu-button" data-dropdown="goto-dropdown">è½¬åˆ°(G)</button>
                <div id="goto-dropdown" class="dropdown-content">
                    <button id="goto-line">è½¬åˆ°è¡Œ...</button>
                </div>
            </div>
            <div class="menu-item-group">
                <button class="menu-button" data-dropdown="help-dropdown">å¸®åŠ©(H)</button>
                <div id="help-dropdown" class="dropdown-content">
                    <button id="help-about">å…³äº</button>
                </div>
            </div>

            <div class="controls-container">
                <div><label for="language-select">è¯­è¨€:</label><select id="language-select"></select></div>
                <div><label for="theme-select">ä¸»é¢˜:</label><select id="theme-select"></select></div>
            </div>
        </div>

        <div class="main-content">
            <div class="activity-bar">
                <div class="icon" id="activity-explorer" title="æ–‡ä»¶æµè§ˆå™¨ (R2)">
                    <svg viewBox="0 0 24 24"><path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"></path></svg>
                </div>
                <div class="icon" id="activity-search" title="Search">
                    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5A6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                </div>
            </div>
            <div class="primary-side-bar" id="r2-file-explorer-panel">
                <h3>R2 å­˜å‚¨æ¡¶</h3>
                <div class="r2-controls">
                   <button id="r2-new-file">æ–°å»ºæ–‡ä»¶</button>
                   <button id="r2-refresh-files">åˆ·æ–°</button>
                </div>
                <ul class="file-list" id="r2-file-list">
                    </ul>
            </div>
            <div class="editor-area">
                <div id="editor-container"></div>
            </div>
        </div>

        <div class="bottom-status-bar">
            <span class="status-item">ä¸»åˆ†æ”¯</span>
            <span class="status-item" id="status-line-col">Ln 1, Col 1</span>
            <span class="status-item" id="current-language-status">Plain Text</span>
            <span class="status-item">UTF-8</span>
            <span class="status-item" id="status-spaces">Spaces: 4</span>
            <span class="status-item">ğŸ˜Š</span>
        </div>
    </div>

    <div id="message-box">ç¼–è¾‘å™¨æ¶ˆæ¯</div>
    <input type="file" id="file-input-local" style="display: none;" />

    <div id="r2-password-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>è¿æ¥åˆ° R2 å­˜å‚¨</h2>
            <label for="r2-password-input">è¯·è¾“å…¥è®¿é—®å¯†ç :</label>
            <input type="password" id="r2-password-input" />
            <button id="r2-password-submit">è¿æ¥</button>
            <button id="r2-password-cancel" class="cancel">å–æ¶ˆ</button>
        </div>
    </div>
    <div id="rename-file-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="rename-modal-title">é‡å‘½åæ–‡ä»¶</h2>
            <label for="new-filename-input">æ–°æ–‡ä»¶å:</label>
            <input type="text" id="new-filename-input" />
            <button id="rename-file-confirm">ç¡®å®š</button>
            <button id="rename-file-cancel" class="cancel">å–æ¶ˆ</button>
        </div>
    </div>
    <div id="goto-line-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>è½¬åˆ°è¡Œ</h2>
            <label for="line-number-input">è¡Œå·:</label>
            <input type="number" id="line-number-input" min="1" />
            <button id="goto-line-confirm">ç¡®å®š</button>
            <button id="goto-line-cancel" class="cancel">å–æ¶ˆ</button>
        </div>
    </div>
    <div id="about-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>å…³äº Monaco åœ¨çº¿ç¼–è¾‘å™¨</h2>
            <p>è¿™æ˜¯ä¸€ä¸ªåŸºäº Monaco Editor æ„å»ºçš„åœ¨çº¿ä»£ç ç¼–è¾‘å™¨ï¼Œé›†æˆ Cloudflare R2 å­˜å‚¨ã€‚</p>
            <p>ç‰ˆæœ¬: 1.2.0 (R2é›†æˆ)</p>
            <button id="about-modal-close">å…³é—­</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/loader.min.js"></script>
    <script>
        // --- Global State & Elements ---
        let editor;
        let r2SessionActive = false;
        let currentR2Path = null; // Path of the file currently open from R2
        let r2FilesCache = []; // Cache of R2 file list

        const editorContainer = document.getElementById('editor-container');
        const languageSelect = document.getElementById('language-select');
        const themeSelect = document.getElementById('theme-select');
        const messageBox = document.getElementById('message-box');
        const statusLineCol = document.getElementById('status-line-col');
        const statusSpaces = document.getElementById('status-spaces');
        const currentLanguageStatusElem = document.getElementById('current-language-status');
        const localFileInput = document.getElementById('file-input-local');

        const activityExplorerIcon = document.getElementById('activity-explorer');
        const r2FileExplorerPanel = document.getElementById('r2-file-explorer-panel');
        const r2PasswordModal = document.getElementById('r2-password-modal');
        const r2PasswordInput = document.getElementById('r2-password-input');
        const r2FileListElement = document.getElementById('r2-file-list');
        const fileSaveR2Button = document.getElementById('file-save-r2');

        const renameFileModal = document.getElementById('rename-file-modal');
        const newFilenameInput = document.getElementById('new-filename-input');
        let fileToRename = null;

        const gotoLineModal = document.getElementById('goto-line-modal');
        const lineNumberInput = document.getElementById('line-number-input');
        const aboutModal = document.getElementById('about-modal');


        // --- API Base Path (Adjust if your workers are on a different path) ---
        const API_BASE = '/api'; // Assumes workers are at /api/auth, /api/files etc.

        // --- Monaco Editor Initialization ---
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs' }});
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(editorContainer, {
                value: '// ç‚¹å‡»å·¦ä¾§â€œæ–‡ä»¶æµè§ˆå™¨â€å›¾æ ‡è¿æ¥åˆ°R2å­˜å‚¨\n// æˆ–ä»â€œæ–‡ä»¶â€èœå•æ‰“å¼€æœ¬åœ°æ–‡ä»¶',
                language: 'plaintext',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: true },
                wordWrap: 'off',
                renderLineHighlight: 'gutter',
                folding: true,
                lineNumbersMinChars: 3,
                glyphMargin: false,
            });

            populateDropdowns();
            updateStatus(); // Initial status update

            // --- Event Listeners ---
            editor.onDidChangeCursorPosition(updateStatus);
            editor.onDidChangeModelOptions(updateStatus);
            editor.onDidChangeModelContent(updateStatus);
            languageSelect.addEventListener('change', handleLanguageChange);
            themeSelect.addEventListener('change', handleThemeChange);

            // Dropdown Menu Logic
            document.querySelectorAll('.menu-button').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const currentlyOpen = document.querySelector('.dropdown-content[style*="display: block"]');
                    const dropdownId = this.dataset.dropdown;
                    const targetDropdown = document.getElementById(dropdownId);
                    closeAllDropdowns();
                    if (currentlyOpen !== targetDropdown) {
                        targetDropdown.style.display = 'block';
                    }
                });
            });
            window.addEventListener('click', closeAllDropdowns);
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.addEventListener('click', event => event.stopPropagation());
            });


            // --- R2 Integration Logic ---
            activityExplorerIcon.addEventListener('click', toggleR2Explorer);
            document.getElementById('r2-password-submit').addEventListener('click', handleR2PasswordSubmit);
            document.getElementById('r2-password-cancel').addEventListener('click', () => r2PasswordModal.style.display = 'none');
            document.getElementById('r2-new-file').addEventListener('click', handleNewR2File);
            document.getElementById('r2-refresh-files').addEventListener('click', () => {
                if(r2SessionActive) fetchR2Files(); else showMessage("è¯·å…ˆè¿æ¥åˆ°R2ã€‚");
            });

            // Menu Item Actions
            // File Menu
            document.getElementById('file-new').addEventListener('click', handleFileNew);
            document.getElementById('file-open-local').addEventListener('click', () => { localFileInput.click(); closeAllDropdowns(); });
            localFileInput.addEventListener('change', handleFileOpenLocal);
            document.getElementById('file-save-r2').addEventListener('click', handleSaveToR2);
            document.getElementById('file-download-local').addEventListener('click', handleFileDownloadLocal);

            // Edit Menu
            document.getElementById('edit-undo').addEventListener('click', () => { editor.trigger('source', 'undo'); closeAllDropdowns(); });
            document.getElementById('edit-redo').addEventListener('click', () => { editor.trigger('source', 'redo'); closeAllDropdowns(); });
            document.getElementById('edit-find').addEventListener('click', () => { editor.getAction('actions.find').run(); closeAllDropdowns(); });
            document.getElementById('edit-replace').addEventListener('click', () => { editor.getAction('actions.replace').run(); closeAllDropdowns();});
            // Selection Menu
            document.getElementById('selection-select-all').addEventListener('click', () => { editor.setSelection(editor.getModel().getFullModelRange()); editor.focus(); closeAllDropdowns(); });
            // View Menu
            document.getElementById('view-toggle-minimap').addEventListener('click', () => { const n = !editor.getOption(monaco.editor.EditorOption.minimap).enabled; editor.updateOptions({ minimap: { enabled: n } }); showMessage(`Minimap å·²${n?'å¯ç”¨':'ç¦ç”¨'}`); closeAllDropdowns(); });
            document.getElementById('view-toggle-wordwrap').addEventListener('click', () => { const c = editor.getOption(monaco.editor.EditorOption.wordWrap); const n = c === 'off' ? 'on' : 'off'; editor.updateOptions({ wordWrap: n }); showMessage(`è‡ªåŠ¨æ¢è¡Œå·²${n==='on'?'å¯ç”¨':'ç¦ç”¨'}`); closeAllDropdowns(); });
            // Go To Menu
            document.getElementById('goto-line').addEventListener('click', () => { gotoLineModal.style.display = 'flex'; lineNumberInput.value = editor.getPosition()?.lineNumber || 1; lineNumberInput.focus(); lineNumberInput.select(); closeAllDropdowns();});
            document.getElementById('goto-line-confirm').addEventListener('click', () => { const line = parseInt(lineNumberInput.value, 10); if (!isNaN(line) && line > 0) { editor.revealLineInCenter(line); editor.setPosition({ lineNumber: line, column: 1 }); editor.focus(); } gotoLineModal.style.display = 'none'; });
            document.getElementById('goto-line-cancel').addEventListener('click', () => { gotoLineModal.style.display = 'none'; });
            // Help Menu
            document.getElementById('help-about').addEventListener('click', () => { aboutModal.style.display = 'flex'; closeAllDropdowns(); });
            document.getElementById('about-modal-close').addEventListener('click', () => { aboutModal.style.display = 'none'; });
            // Sidebar Search
            document.getElementById('activity-search').addEventListener('click', () => { editor.getAction('actions.find').run(); });
            // Rename Modal
            document.getElementById('rename-file-confirm').addEventListener('click', handleRenameR2FileConfirm);
            document.getElementById('rename-file-cancel').addEventListener('click', () => { renameFileModal.style.display = 'none'; fileToRename = null; });


            // Initial state for R2 save button
            updateR2SaveButtonState();
        });

        function populateDropdowns() {
            const commonLanguages = [
                { value: 'plaintext', text: 'Plain Text' }, { value: 'javascript', text: 'JavaScript' },
                { value: 'typescript', text: 'TypeScript' }, { value: 'python', text: 'Python' },
                { value: 'html', text: 'HTML' }, { value: 'css', text: 'CSS' },
                { value: 'json', text: 'JSON' }, { value: 'markdown', text: 'Markdown' },
                { value: 'java', text: 'Java' }, { value: 'csharp', text: 'C#' }, { value: 'cpp', text: 'C++' },
                { value: 'xml', text: 'XML' }, { value: 'php', text: 'PHP' }, { value: 'sql', text: 'SQL' },
                { value: 'ruby', text: 'Ruby' }, { value: 'go', text: 'Go' }, { value: 'rust', text: 'Rust'}
            ];
            commonLanguages.forEach(lang => {
                const opt = document.createElement('option');
                opt.value = lang.value; opt.textContent = lang.text;
                languageSelect.appendChild(opt);
            });
            languageSelect.value = 'plaintext';

            ['vs', 'vs-dark', 'hc-black', 'hc-light'].forEach(themeName => {
                const opt = document.createElement('option');
                opt.value = themeName; opt.textContent = themeName.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
                themeSelect.appendChild(opt);
            });
            themeSelect.value = 'vs-dark';
        }

        function handleLanguageChange() {
            const langVal = languageSelect.value;
            monaco.editor.setModelLanguage(editor.getModel(), langVal);
            updateStatus();
            showMessage(`è¯­è¨€å·²æ›´æ”¹ä¸º: ${languageSelect.options[languageSelect.selectedIndex].text}`);
        }

        function handleThemeChange() {
            const selectedTheme = themeSelect.value;
            monaco.editor.setTheme(selectedTheme);
            if (selectedTheme === 'vs-dark' || selectedTheme === 'hc-black') {
                document.body.style.backgroundColor = '#1e1e1e'; document.body.style.color = '#cccccc';
            } else {
                document.body.style.backgroundColor = '#f3f4f6'; document.body.style.color = '#1f2937';
            }
            showMessage(`ä¸»é¢˜å·²æ›´æ”¹ä¸º: ${selectedTheme}`);
        }

        function handleFileNew() {
            editor.setValue('');
            currentR2Path = null;
            updateR2SaveButtonState();
            showMessage('æ–°æ–‡ä»¶å·²åˆ›å»º (ç¼–è¾‘å™¨å·²æ¸…ç©º)');
            if (r2SessionActive) renderR2FileList(); // To deselect active file
            closeAllDropdowns();
            updateStatus();
        }

        function handleFileOpenLocal(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    editor.setValue(e.target.result);
                    currentR2Path = null; // It's a local file, not from R2
                    showMessage(`æœ¬åœ°æ–‡ä»¶ ${file.name} å·²åŠ è½½`);
                    updateR2SaveButtonState(); // R2 save should prompt for new R2 name
                    if (r2SessionActive) renderR2FileList(); // Deselect R2 active file

                    const extension = file.name.split('.').pop().toLowerCase();
                    const langMap = { js: 'javascript', ts: 'typescript', py: 'python', java: 'java', html: 'html', css: 'css', json: 'json', md: 'markdown', txt: 'plaintext' };
                    const defaultLang = 'plaintext';
                    const selectedLang = langMap[extension] || defaultLang;
                    if (Array.from(languageSelect.options).some(opt => opt.value === selectedLang)) {
                        languageSelect.value = selectedLang;
                        monaco.editor.setModelLanguage(editor.getModel(), selectedLang);
                    }
                    updateStatus();
                };
                reader.readAsText(file);
            }
            localFileInput.value = ''; // Reset file input
        }

        function handleFileDownloadLocal() {
            const text = editor.getValue();
            const currentLang = languageSelect.value;
            let filename = "download.txt";
            const langExtMap = { javascript: '.js', typescript: '.ts', python: '.py', java: '.java', html: '.html', css: '.css', json: '.json', markdown: '.md', plaintext: '.txt' };
            if (langExtMap[currentLang]) {
                filename = `code${langExtMap[currentLang]}`;
            }
            const userFilename = prompt("è¯·è¾“å…¥è¦ä¸‹è½½çš„æ–‡ä»¶å:", filename);
            if (!userFilename) { showMessage("ä¸‹è½½å·²å–æ¶ˆã€‚"); return; }

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = userFilename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showMessage(`æ–‡ä»¶å·²ä¸‹è½½ä¸º ${userFilename}`);
            closeAllDropdowns();
        }


        function toggleR2Explorer() {
            if (!r2SessionActive) {
                r2PasswordModal.style.display = 'flex';
                r2PasswordInput.focus();
            } else {
                r2FileExplorerPanel.classList.toggle('visible');
                activityExplorerIcon.classList.toggle('active', r2FileExplorerPanel.classList.contains('visible'));
                if (r2FileExplorerPanel.classList.contains('visible') && r2FilesCache.length === 0) {
                    fetchR2Files();
                }
            }
        }

        async function handleR2PasswordSubmit() {
            const password = r2PasswordInput.value;
            if (!password) { showMessage("è¯·è¾“å…¥å¯†ç ã€‚"); return; }

            showMessage("æ­£åœ¨è¿æ¥åˆ°R2...", 5000);
            try {
                const response = await fetch(`${API_BASE}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    r2SessionActive = true;
                    showMessage("R2 è¿æ¥æˆåŠŸï¼");
                    r2PasswordModal.style.display = 'none';
                    r2PasswordInput.value = '';
                    r2FileExplorerPanel.classList.add('visible');
                    activityExplorerIcon.classList.add('active');
                    updateR2SaveButtonState();
                    fetchR2Files();
                } else {
                    showMessage(`è®¤è¯å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                    r2SessionActive = false;
                    updateR2SaveButtonState();
                }
            } catch (error) {
                showMessage(`è¿æ¥é”™è¯¯: ${error.message}`);
                r2SessionActive = false;
                updateR2SaveButtonState();
            }
        }

        async function fetchR2Files() {
            if (!r2SessionActive) { showMessage("æœªè¿æ¥åˆ° R2ã€‚"); return; }
            showMessage("æ­£åœ¨è·å–æ–‡ä»¶åˆ—è¡¨...", 5000);
            try {
                const response = await fetch(`${API_BASE}/files`);
                if (!response.ok) throw new Error(`HTTP error ${response.status}. ${await response.text()}`);
                const data = await response.json();

                if (data.success) {
                    r2FilesCache = data.files.sort((a,b) => a.key.localeCompare(b.key));
                    renderR2FileList();
                    showMessage("æ–‡ä»¶åˆ—è¡¨å·²æ›´æ–°ã€‚");
                } else {
                    showMessage(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                showMessage(`è·å–æ–‡ä»¶åˆ—è¡¨é”™è¯¯: ${error.message}`);
            }
        }

        function renderR2FileList() {
            r2FileListElement.innerHTML = '';
            if (!r2SessionActive) {
                 const li = document.createElement('li');
                 li.textContent = 'æœªè¿æ¥åˆ°R2ã€‚';
                 li.style.fontStyle = 'italic';
                 li.style.padding = '0.5rem';
                 r2FileListElement.appendChild(li);
                 return;
            }
            if (r2FilesCache.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'å­˜å‚¨æ¡¶ä¸ºç©ºæˆ–æ— æ³•è®¿é—®ã€‚';
                li.style.fontStyle = 'italic';
                li.style.padding = '0.5rem';
                r2FileListElement.appendChild(li);
                return;
            }
            r2FilesCache.forEach(file => {
                const li = document.createElement('li');
                li.dataset.filename = file.key;
                if(file.key === currentR2Path) li.classList.add('active-file');

                const nameSpan = document.createElement('span');
                nameSpan.className = 'file-item-name';
                nameSpan.textContent = file.key;
                nameSpan.title = `${file.key} (${file.size ? (file.size / 1024).toFixed(2) + ' KB' : 'N/A'})`;
                li.appendChild(nameSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'file-item-actions';

                const openButton = document.createElement('button');
                openButton.innerHTML = '&#128194;'; // Open folder icon
                openButton.title = 'æ‰“å¼€';
                openButton.onclick = (e) => { e.stopPropagation(); openR2File(file.key); };
                actionsDiv.appendChild(openButton);

                const renameButton = document.createElement('button');
                renameButton.innerHTML = '&#9998;'; // Pencil icon
                renameButton.title = 'é‡å‘½å';
                renameButton.onclick = (e) => { e.stopPropagation(); promptRenameR2File(file.key); };
                actionsDiv.appendChild(renameButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '&#128465;'; // Trash can icon
                deleteButton.title = 'åˆ é™¤';
                deleteButton.onclick = (e) => { e.stopPropagation(); deleteR2File(file.key); };
                actionsDiv.appendChild(deleteButton);

                li.appendChild(actionsDiv);
                li.onclick = () => openR2File(file.key);
                r2FileListElement.appendChild(li);
            });
        }

        async function openR2File(filename) {
            if (!r2SessionActive) { showMessage("æœªè¿æ¥åˆ° R2ã€‚"); return; }
            showMessage(`æ­£åœ¨æ‰“å¼€ ${filename}...`, 5000);
            try {
                const response = await fetch(`${API_BASE}/files/${encodeURIComponent(filename)}`);
                if (!response.ok) {
                     const errorText = await response.text(); // Try to get text for more info
                     let errorDetail = `HTTP error ${response.status}`;
                     try { errorDetail = JSON.parse(errorText).error || errorDetail; } catch(e){}
                     throw new Error(errorDetail);
                }
                const content = await response.text();
                editor.setValue(content);
                currentR2Path = filename;

                const extension = filename.split('.').pop().toLowerCase();
                const langMap = { js: 'javascript', ts: 'typescript', py: 'python', java: 'java', html: 'html', css: 'css', json: 'json', md: 'markdown', txt: 'plaintext', xml: 'xml', php: 'php', sql: 'sql', rb: 'ruby', go: 'go', rs: 'rust' };
                const defaultLang = 'plaintext';
                const selectedLang = langMap[extension] || defaultLang;

                if (Array.from(languageSelect.options).some(opt => opt.value === selectedLang)) {
                    languageSelect.value = selectedLang;
                    monaco.editor.setModelLanguage(editor.getModel(), selectedLang);
                }
                updateStatus();
                renderR2FileList();
                showMessage(`${filename} å·²æ‰“å¼€ã€‚`);
                updateR2SaveButtonState();

            } catch (error) {
                showMessage(`æ‰“å¼€æ–‡ä»¶é”™è¯¯: ${error.message}`);
                currentR2Path = null;
                updateR2SaveButtonState();
            }
        }

        async function handleSaveToR2() {
            if (!r2SessionActive) { showMessage("æœªè¿æ¥åˆ° R2ã€‚è¯·å…ˆè¿æ¥ã€‚"); closeAllDropdowns(); return; }

            let filenameToSave = currentR2Path;
            if (!filenameToSave) {
                filenameToSave = prompt("è¯·è¾“å…¥è¦ä¿å­˜åˆ° R2 çš„æ–‡ä»¶å (ä¾‹å¦‚: new_file.js):", currentR2Path || "untitled.txt");
                if (!filenameToSave) { showMessage("å·²å–æ¶ˆä¿å­˜ã€‚"); closeAllDropdowns(); return; }
            }

            const content = editor.getValue();
            showMessage(`æ­£åœ¨ä¿å­˜ ${filenameToSave} åˆ° R2...`, 5000);
            try {
                const response = await fetch(`${API_BASE}/files/${encodeURIComponent(filenameToSave)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'text/plain' }, // Worker can set specific type
                    body: content
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    showMessage(`${filenameToSave} å·²æˆåŠŸä¿å­˜åˆ° R2ã€‚`);
                    currentR2Path = filenameToSave;
                    if (!r2FilesCache.some(f => f.key === filenameToSave)) { // If it's a new file add to cache for immediate render
                        r2FilesCache.push({key: filenameToSave, size: content.length, uploaded: new Date().toISOString()});
                        r2FilesCache.sort((a,b) => a.key.localeCompare(b.key));
                    } else { // Update size if existing
                         const idx = r2FilesCache.findIndex(f => f.key === filenameToSave);
                         if(idx !== -1) r2FilesCache[idx].size = content.length;
                    }
                    renderR2FileList();
                    updateR2SaveButtonState();
                } else {
                    showMessage(`ä¿å­˜å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                showMessage(`ä¿å­˜é”™è¯¯: ${error.message}`);
            }
            closeAllDropdowns();
        }

        async function deleteR2File(filename) {
            if (!r2SessionActive) { showMessage("æœªè¿æ¥åˆ° R2ã€‚"); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ R2 ä¸­çš„æ–‡ä»¶ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;

            showMessage(`æ­£åœ¨åˆ é™¤ ${filename}...`, 5000);
            try {
                const response = await fetch(`${API_BASE}/files/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                const data = await response.json();
                if (response.ok && data.success) {
                    showMessage(`${filename} å·²åˆ é™¤ã€‚`);
                    if (currentR2Path === filename) {
                        editor.setValue(`// ${filename} å·²ä» R2 åˆ é™¤ã€‚\n// ç¼–è¾‘å™¨å†…å®¹ä¿ç•™ï¼Œå¯å¦å­˜æˆ–æ–°å»ºã€‚`);
                        currentR2Path = null;
                        updateR2SaveButtonState();
                    }
                    r2FilesCache = r2FilesCache.filter(f => f.key !== filename); // Remove from cache
                    renderR2FileList();
                } else {
                    showMessage(`åˆ é™¤å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                showMessage(`åˆ é™¤é”™è¯¯: ${error.message}`);
            }
        }
        
        function promptRenameR2File(filename) {
            if (!r2SessionActive) { showMessage("æœªè¿æ¥åˆ° R2ã€‚"); return; }
            fileToRename = filename;
            document.getElementById('rename-modal-title').textContent = `é‡å‘½å "${filename}"`;
            newFilenameInput.value = filename;
            renameFileModal.style.display = 'flex';
            newFilenameInput.focus();
            newFilenameInput.select();
        }

        async function handleRenameR2FileConfirm() {
            const newName = newFilenameInput.value.trim();
            if (!newName || newName === fileToRename) {
                showMessage("æ–‡ä»¶åæ— æ•ˆæˆ–æœªæ›´æ”¹ã€‚");
                renameFileModal.style.display = 'none';
                return;
            }
            renameFileModal.style.display = 'none';
            showMessage(`æ­£åœ¨é‡å‘½å ${fileToRename} ä¸º ${newName}...`, 5000);

            try {
                const response = await fetch(`${API_BASE}/files/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldFilename: fileToRename, newFilename: newName })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    showMessage(`æ–‡ä»¶å·²é‡å‘½åä¸º ${newName}`);
                    if (currentR2Path === fileToRename) {
                        currentR2Path = newName;
                    }
                    // Update cache
                    const oldFileIndex = r2FilesCache.findIndex(f => f.key === fileToRename);
                    if (oldFileIndex !== -1) {
                        r2FilesCache[oldFileIndex].key = newName;
                        r2FilesCache.sort((a,b) => a.key.localeCompare(b.key));
                    }
                    renderR2FileList();
                    updateR2SaveButtonState(); // If current file was renamed
                } else {
                    showMessage(`é‡å‘½åå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                showMessage(`é‡å‘½åé”™è¯¯: ${error.message}`);
            }
            fileToRename = null;
        }

        async function handleNewR2File() {
            if (!r2SessionActive) { showMessage("æœªè¿æ¥åˆ° R2ã€‚"); return; }
            const newFilename = prompt("è¯·è¾“å…¥æ–°æ–‡ä»¶å (ä¾‹å¦‚: script.js):", "new_file.txt");
            if (newFilename) {
                const existingFile = r2FilesCache.find(f => f.key === newFilename);
                if (existingFile) {
                    if(!confirm(`æ–‡ä»¶ "${newFilename}" å·²å­˜åœ¨äºR2ä¸­ã€‚è¦æ‰“å¼€å¹¶è¦†ç›–å®ƒå—ï¼Ÿ (é€‰æ‹©â€œå–æ¶ˆâ€åˆ™ä»…åœ¨ç¼–è¾‘å™¨ä¸­ä½œä¸ºæ–°æ ‡ç­¾æ‰“å¼€)`)){
                         editor.setValue(`// æ–°å»º: ${newFilename}\n`);
                         currentR2Path = null;
                         showMessage(`åœ¨ç¼–è¾‘å™¨ä¸­ä¸º "${newFilename}" åˆ›å»ºäº†æ–°æ ‡ç­¾é¡µã€‚è®°å¾—ä¿å­˜åˆ°R2ã€‚`);
                         updateR2SaveButtonState();
                         renderR2FileList();
                         return;
                    }
                    // If user chose to overwrite, open it
                    openR2File(newFilename);
                    return;
                }
                // If file doesn't exist, treat as a new unsaved R2 file
                editor.setValue(`// æ–°æ–‡ä»¶: ${newFilename}\n// åœ¨æ­¤ç¼–è¾‘å¹¶ä½¿ç”¨ "æ–‡ä»¶" -> "ä¿å­˜åˆ° R2" è¿›è¡Œä¿å­˜ã€‚`);
                currentR2Path = newFilename; // Tentatively set path for saving
                showMessage(`"${newFilename}" å·²åœ¨ç¼–è¾‘å™¨ä¸­å‡†å¤‡å¥½ã€‚ç¼–è¾‘åè¯·ä¿å­˜åˆ° R2ã€‚`);
                updateR2SaveButtonState();
                // Do not add to r2FilesCache yet, only after first save
                renderR2FileList(); // Update list to remove highlight from previous file
            }
        }

        function updateR2SaveButtonState() {
            if (r2SessionActive) {
                fileSaveR2Button.classList.remove('disabled');
                fileSaveR2Button.disabled = false;
                fileSaveR2Button.title = currentR2Path ? `ä¿å­˜ ${currentR2Path} åˆ° R2` : "ä¿å­˜å½“å‰å†…å®¹åˆ° R2 (å°†æç¤ºè¾“å…¥æ–‡ä»¶å)";
            } else {
                fileSaveR2Button.classList.add('disabled');
                fileSaveR2Button.disabled = true;
                fileSaveR2Button.title = "å…ˆè¿æ¥åˆ°R2æ‰èƒ½ä¿å­˜";
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            clearTimeout(messageBox.timeoutId);
            messageBox.timeoutId = setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }
        function updateStatus() {
             if (!editor) return;
             const position = editor.getPosition();
             if (position) {
                 statusLineCol.textContent = `Ln ${position.lineNumber}, Col ${position.column}`;
             }
             const modelOptions = editor.getModel()?.getOptions();
             if (modelOptions) {
                 statusSpaces.textContent = `${modelOptions.insertSpaces ? 'Spaces' : 'Tab Size'}: ${modelOptions.tabSize}`;
             }
             currentLanguageStatusElem.textContent = languageSelect.options[languageSelect.selectedIndex]?.text || 'Plain Text';
        }
    </script>
</body>
</html>
